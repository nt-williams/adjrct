#' Create RCT Survival Metadata
#'
#' Create RCT survival metadata to be used for estimation of the
#' restricted mean survival time and survival probability.
#'
#' @param formula An object of class "formula". The left hand side should be
#'   specified using \code{Surv(time, status)} where time is the name of the
#'   variable containing follow-up time and status is the name of the indicator variable
#'   with 0 = right censored and 1 = event at \code{time}. The right hand
#'   side should contain the target variable of interest and baseline prognostic covariates.
#' @param target The name of the target variable of interest; i.e., the randomized condition.
#' @param data A data frame containing the variables in the model.
#' @param coarsen An optional integer that specifies if and how \code{time} should
#'   be categorized into coarser intervals.
#' @param estimator The method to be used for computing estimands. Options are "tmle"
#'   for Targeted Maximum Likelihood Estimation (the default), "aipw" for Augmented IPW,
#'   and "km" for Kaplan-Meier.
#' @param lasso Should LASSO be used for fitting? Default is \code{FALSE}.
#'
#' @family survrct functions
#'
#' @return An R6 object of class "Survival".
#' @export
#'
#' @examples
#' \donttest{
#' survrct(Surv(time, status) ~ trt + age + sex + obstruct + perfor + adhere + surg,
#'         target = "trt", data = colon, coarsen = 30, estimator = "tmle")
#' }
survrct <- function(formula, target, data, coarsen = 1,
                    estimator = c("tmle", "aipw", "km"),
                    lasso = FALSE) {
  Survival$
    new(formula, target, data, match.arg(estimator))$
    prepare_data(coarsen)$
    fit_nuis(if (match.arg(estimator) == "km") FALSE else lasso)
}

#' Estimate Restricted Mean Survival Time
#'
#' @param metadata An object of class "Survival" generated by a call to \code{metadata()}.
#' @param horizon The time horizon to evaluate at. If \code{NULL}, computes
#'   RMST at all possible time horizons.
#'
#' @family survrct functions
#' @seealso \code{\link{survrct}} for creating \code{metadata}.
#'
#' @return A list of class \code{rmst} containing the following components:
#'
#' \item{estimator}{The estimation method used.}
#' \item{horizon}{The time horizons RMST was evaluated at.}
#' \item{standard_error}{The computed estimates for each time horizon including
#'                       the efficient influence function, standard errors, and
#'                       confidence intervals.}
#'
#' @export
#'
#' @examples
#' \donttest{
#' surv <- survrct(Surv(time, status) ~ trt + age + sex + obstruct +
#'                    perfor + adhere + surg,
#'                 target = "trt", data = colon, coarsen = 30, estimator = "tmle")
#' rmst(surv, 60)
#' }
rmst <- function(metadata, horizon = NULL) {
  metadata$evaluate_horizon(horizon, "rmst")
  out <- list(estimator = metadata$estimator,
              horizon   = metadata$horizon,
              estimates = compute_rmst(metadata))
  class(out) <- "rmst"
  out
}

#' Estimate Survival Probabilities
#'
#' @param metadata An object of class "Survival" generated by a call to \code{metadata()}.
#' @param horizon The time horizon to evaluate at. If \code{NULL}, computes
#'   survival probabilities at all time points.
#'
#' @family survrct functions
#' @seealso \code{\link{survrct}} for creating \code{metadata}.
#'
#' @return A list of class \code{survprob} containing the following components:
#'
#' \item{estimator}{The estimation method used.}
#' \item{horizon}{The time horizons the survival probability was evaluated at.}
#' \item{standard_error}{The computed estimates for each time horizon including the
#'                       efficient influence function, standard errors,
#'                       and confidence intervals.}
#'
#' @export
#'
#' @examples
#' \donttest{
#' surv <- survrct(Surv(time, status) ~ trt + age + sex + obstruct +
#'                    perfor + adhere + surg,
#'                 target = "trt", data = colon, coarsen = 30, estimator = "tmle")
#' survprob(surv, 60)
#' }
survprob <- function(metadata, horizon = NULL) {
  metadata$evaluate_horizon(horizon, "survprob")
  out <- list(estimator = metadata$estimator,
              horizon = metadata$horizon,
              estimates = compute_survprob(metadata))
  class(out) <- "survprob"
  out
}

#' Create RCT Ordinal Metadata
#'
#' Create RCT ordinal metadata to be used for estimation of the
#' average log odds ratio, counterfactual marginal CDFs, and Mann-Whitney statistic.
#'
#' @param formula An object of class "formula". The left hand side should be
#'   the outcome variable. The right hand
#'   side should contain the target variable of interest and baseline prognostic covariates.
#' @param target The name of the target variable of interest; i.e., the randomized condition.
#' @param data A data frame containing the variables in the model.
#' @param estimator The method to be used for computing estimands. Options are "tmle"
#'   for Targeted Maximum Likelihood Estimation (the default), "aipw" for Augmented IPW,
#'   and "unadjusted" for the unadjusted estimator.
#'
#' @family ordinal functions
#'
#' @return An R6 object of class "Ordinal".
#' @export
ordinalrct <- function(formula, target, data, estimator = c("tmle", "aipw", "unadjusted")) {
  Ordinal$
    new(formula, target, data, match.arg(estimator))$
    prepare_data()$
    fit_nuis()
}

#' Estimate Average Log Odds Ratio
#'
#' @param metadata An object of class "Survival" generated by a call to \code{metadata()}.
#'
#' @family ordinalrct functions
#' @seealso \code{\link{ordinalrct}} for creating \code{metadata}.
#'
#' @return A list of class \code{lor} containing the following components:
#'
#' \item{estimator}{The estimation method used.}
#' \item{standard_error}{The computed estimates including the
#'                       efficient influence function, standard errors,
#'                       and confidence intervals.}
#'
#' @export
log_or <- function(metadata) {
  out <- list(estimator = metadata$estimator,
              estimates = compute_lor(metadata))
  class(out) <- "lor"
  out
}

cdf <- function(metadata) {
  out <- list(estimator = metadata$estimator,
              estimates = compute_cdf(metadata))
  class(out) <- "cdf"
  out
}

